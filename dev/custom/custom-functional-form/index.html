<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Custom functional form · ReactiveMP.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">ReactiveMP.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><span class="tocitem">Custom functionality</span><ul><li class="is-active"><a class="tocitem" href>Custom functional form</a><ul class="internal"><li><a class="tocitem" href="#Interface"><span>Interface</span></a></li><li><a class="tocitem" href="#custom-functional-form-example"><span>Custom Functional Form Example</span></a></li></ul></li><li><a class="tocitem" href="../custom-addons/">Custom addons</a></li></ul></li><li><span class="tocitem">Library</span><ul><li><a class="tocitem" href="../../lib/message/">Messages</a></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Factor nodes</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../lib/nodes/nodes/">Overview</a></li><li><a class="tocitem" href="../../lib/nodes/flow/">Flow</a></li></ul></li><li><a class="tocitem" href="../../lib/rules/rules/">Message update rules</a></li><li><a class="tocitem" href="../../lib/prod/">Prod implementation</a></li><li><a class="tocitem" href="../../lib/helpers/">Helper utils</a></li><li><a class="tocitem" href="../../lib/algebra/common/">Algebra utils</a></li><li><a class="tocitem" href="../../lib/methods/">Exported methods</a></li></ul></li><li><a class="tocitem" href="../../extra/contributing/">Contributing</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Custom functionality</a></li><li class="is-active"><a href>Custom functional form</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Custom functional form</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/biaslab/ReactiveMP.jl/blob/master/docs/src/custom/custom-functional-form.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="custom-functional-form"><a class="docs-heading-anchor" href="#custom-functional-form">Custom Functional Form Specification</a><a id="custom-functional-form-1"></a><a class="docs-heading-anchor-permalink" href="#custom-functional-form" title="Permalink"></a></h1><p>In a nutshell, functional form constraints defines a function that approximates the product of colliding messages and computes posterior marginal that can be used later on during the inference procedure. An important part of the functional forms constraint implementation is the <a href="../../lib/prod/#Base.prod-Tuple{ProdAnalytical, Any, Any}"><code>prod</code></a> function. More information about <a href="../../lib/prod/#Base.prod-Tuple{ProdAnalytical, Any, Any}"><code>prod</code></a> function is present in the <a href="../../lib/prod/#lib-prod">Prod Implementation</a> section. For example, if we refer to our <code>CustomFunctionalForm</code> as to <code>f</code> we can see the whole functional form constraints pipeline as:</p><p class="math-container">\[q(x) = f\left(\frac{\overrightarrow{\mu}(x)\overleftarrow{\mu}(x)}{\int \overrightarrow{\mu}(x)\overleftarrow{\mu}(x) \mathrm{d}x}\right)\]</p><h2 id="Interface"><a class="docs-heading-anchor" href="#Interface">Interface</a><a id="Interface-1"></a><a class="docs-heading-anchor-permalink" href="#Interface" title="Permalink"></a></h2><p><code>ReactiveMP.jl</code>, however, uses some extra utility functions to define functional form constraint behaviour. Here we briefly describe all utility function. If you are only interested in the concrete example, you may directly head to the <a href="#custom-functional-form-example">Custom Functional Form</a> example at the end of this section.</p><h3 id="Abstract-super-type"><a class="docs-heading-anchor" href="#Abstract-super-type">Abstract super type</a><a id="Abstract-super-type-1"></a><a class="docs-heading-anchor-permalink" href="#Abstract-super-type" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-binding" id="ReactiveMP.AbstractFormConstraint" href="#ReactiveMP.AbstractFormConstraint"><code>ReactiveMP.AbstractFormConstraint</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">AbstractFormConstraint</code></pre><p>Every functional form constraint is a subtype of <code>AbstractFormConstraint</code> abstract type.</p><p>Note: this is not strictly necessary, but it makes automatic dispatch easier and compatible with the <code>CompositeFormConstraint</code>.</p><p>See also: <a href="#ReactiveMP.CompositeFormConstraint"><code>CompositeFormConstraint</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/biaslab/ReactiveMP.jl/blob/3ad37f768f4329098e47988cb2ee2b26bbfa75f3/src/constraints/form.jl#L16-L24">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ReactiveMP.CompositeFormConstraint" href="#ReactiveMP.CompositeFormConstraint"><code>ReactiveMP.CompositeFormConstraint</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">CompositeFormConstraint</code></pre><p>Creates a composite form constraint that applies form constraints in order. The composed form constraints must be compatible and have the exact same <code>form_check_strategy</code>.  Any functional form constraint that defines <code>is_point_mass_form_constraint() = true</code> may be used only as the last element of the composition.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/biaslab/ReactiveMP.jl/blob/3ad37f768f4329098e47988cb2ee2b26bbfa75f3/src/constraints/form.jl#L143-L148">source</a></section></article><h3 id="Form-check-strategy"><a class="docs-heading-anchor" href="#Form-check-strategy">Form check strategy</a><a id="Form-check-strategy-1"></a><a class="docs-heading-anchor-permalink" href="#Form-check-strategy" title="Permalink"></a></h3><p>Every custom functional form must implement a new method for the <a href="#ReactiveMP.default_form_check_strategy"><code>default_form_check_strategy</code></a> function that returns either <a href="#ReactiveMP.FormConstraintCheckEach"><code>FormConstraintCheckEach</code></a> or <a href="#ReactiveMP.FormConstraintCheckLast"><code>FormConstraintCheckLast</code></a>.</p><ul><li><code>FormConstraintCheckLast</code>: <code>q(x) = f(μ1(x) * μ2(x) * μ3(x))</code></li><li><code>FormConstraintCheckEach</code>: <code>q(x) = f(f(μ1(x) * μ2(x)) * μ3(x))</code></li></ul><article class="docstring"><header><a class="docstring-binding" id="ReactiveMP.default_form_check_strategy" href="#ReactiveMP.default_form_check_strategy"><code>ReactiveMP.default_form_check_strategy</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">default_form_check_strategy(form_constraint)</code></pre><p>Returns a default check strategy (e.g. <code>FormConstraintCheckEach</code> or <code>FormConstraintCheckEach</code>) for a given form constraint object.</p><p>See also: <a href="#ReactiveMP.FormConstraintCheckEach"><code>FormConstraintCheckEach</code></a>, <a href="#ReactiveMP.FormConstraintCheckLast"><code>FormConstraintCheckLast</code></a>, <a href="#ReactiveMP.constrain_form"><code>constrain_form</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/biaslab/ReactiveMP.jl/blob/3ad37f768f4329098e47988cb2ee2b26bbfa75f3/src/constraints/form.jl#L58-L64">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ReactiveMP.FormConstraintCheckEach" href="#ReactiveMP.FormConstraintCheckEach"><code>ReactiveMP.FormConstraintCheckEach</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">FormConstraintCheckEach</code></pre><p>This form constraint check strategy checks functional form of the messages product after each product in an equality chain.  Usually if a variable has been connected to multiple nodes we want to perform multiple <code>prod</code> to obtain a posterior marginal. With this form check strategy <code>constrain_form</code> function will be executed after each subsequent <code>prod</code> function.</p><p>See also: <a href="#ReactiveMP.FormConstraintCheckLast"><code>FormConstraintCheckLast</code></a>, <a href="#ReactiveMP.default_form_check_strategy"><code>default_form_check_strategy</code></a>, <a href="#ReactiveMP.constrain_form"><code>constrain_form</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/biaslab/ReactiveMP.jl/blob/3ad37f768f4329098e47988cb2ee2b26bbfa75f3/src/constraints/form.jl#L27-L35">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ReactiveMP.FormConstraintCheckLast" href="#ReactiveMP.FormConstraintCheckLast"><code>ReactiveMP.FormConstraintCheckLast</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">FormConstraintCheckEach</code></pre><p>This form constraint check strategy checks functional form of the last messages product in the equality chain.  Usually if a variable has been connected to multiple nodes we want to perform multiple <code>prod</code> to obtain a posterior marginal. With this form check strategy <code>constrain_form</code> function will be executed only once after all subsequenct <code>prod</code> functions have been executed.</p><p>See also: <a href="#ReactiveMP.FormConstraintCheckLast"><code>FormConstraintCheckLast</code></a>, <a href="#ReactiveMP.default_form_check_strategy"><code>default_form_check_strategy</code></a>, <a href="#ReactiveMP.constrain_form"><code>constrain_form</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/biaslab/ReactiveMP.jl/blob/3ad37f768f4329098e47988cb2ee2b26bbfa75f3/src/constraints/form.jl#L38-L46">source</a></section></article><h3 id="Prod-constraint"><a class="docs-heading-anchor" href="#Prod-constraint">Prod constraint</a><a id="Prod-constraint-1"></a><a class="docs-heading-anchor-permalink" href="#Prod-constraint" title="Permalink"></a></h3><p>Every custom functional form must implement a new method for the <a href="#ReactiveMP.default_prod_constraint"><code>default_prod_constraint</code></a> function that returns a proper <code>prod_constraint</code> object.</p><article class="docstring"><header><a class="docstring-binding" id="ReactiveMP.default_prod_constraint" href="#ReactiveMP.default_prod_constraint"><code>ReactiveMP.default_prod_constraint</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">default_prod_constraint(form_constraint)</code></pre><p>Returns a default prod constraint needed to apply a given <code>form_constraint</code>. For most form constraints this function returns <code>ProdGeneric</code>.</p><p>See also: <a href="../../lib/prod/#ReactiveMP.ProdAnalytical"><code>ProdAnalytical</code></a>, <a href="../../lib/prod/#ReactiveMP.ProdGeneric"><code>ProdGeneric</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/biaslab/ReactiveMP.jl/blob/3ad37f768f4329098e47988cb2ee2b26bbfa75f3/src/constraints/form.jl#L67-L73">source</a></section></article><h3 id="Constrain-form,-a.k.a-f"><a class="docs-heading-anchor" href="#Constrain-form,-a.k.a-f">Constrain form, a.k.a <code>f</code></a><a id="Constrain-form,-a.k.a-f-1"></a><a class="docs-heading-anchor-permalink" href="#Constrain-form,-a.k.a-f" title="Permalink"></a></h3><p>The main function that a custom functional form must implement, which we referred to as <code>f</code> in the beginning of this section, is the <a href="#ReactiveMP.constrain_form"><code>constrain_form</code></a> function.</p><article class="docstring"><header><a class="docstring-binding" id="ReactiveMP.constrain_form" href="#ReactiveMP.constrain_form"><code>ReactiveMP.constrain_form</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">constrain_form(form_constraint, distribution)</code></pre><p>This function must approximate <code>distribution</code> object in a form that satisfies <code>form_constraint</code>.</p><p>See also: <a href="#ReactiveMP.FormConstraintCheckEach"><code>FormConstraintCheckEach</code></a>, <a href="#ReactiveMP.FormConstraintCheckLast"><code>FormConstraintCheckLast</code></a>, <a href="#ReactiveMP.default_form_check_strategy"><code>default_form_check_strategy</code></a>, <a href="#ReactiveMP.is_point_mass_form_constraint"><code>is_point_mass_form_constraint</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/biaslab/ReactiveMP.jl/blob/3ad37f768f4329098e47988cb2ee2b26bbfa75f3/src/constraints/form.jl#L85-L91">source</a></section></article><h3 id="Is-point-mass-form-constraint-(optional)"><a class="docs-heading-anchor" href="#Is-point-mass-form-constraint-(optional)">Is point mass form constraint (optional)</a><a id="Is-point-mass-form-constraint-(optional)-1"></a><a class="docs-heading-anchor-permalink" href="#Is-point-mass-form-constraint-(optional)" title="Permalink"></a></h3><p>Every custom functional form may implement a new method for the <a href="#ReactiveMP.is_point_mass_form_constraint"><code>is_point_mass_form_constraint</code></a> function that returns either <code>true</code> or <code>false</code>. This is an utility function that simplifes computation of the Bethe Free Energy and is not strictly necessary.</p><article class="docstring"><header><a class="docstring-binding" id="ReactiveMP.is_point_mass_form_constraint" href="#ReactiveMP.is_point_mass_form_constraint"><code>ReactiveMP.is_point_mass_form_constraint</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">is_point_mass_form_constraint(form_constraint)</code></pre><p>Specifies whether form constraint always returns PointMass estimates or not. For a given <code>form_constraint</code> returns either <code>true</code> or <code>false</code>.</p><p>See also: <a href="#ReactiveMP.FormConstraintCheckEach"><code>FormConstraintCheckEach</code></a>, <a href="#ReactiveMP.FormConstraintCheckLast"><code>FormConstraintCheckLast</code></a>, <a href="#ReactiveMP.constrain_form"><code>constrain_form</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/biaslab/ReactiveMP.jl/blob/3ad37f768f4329098e47988cb2ee2b26bbfa75f3/src/constraints/form.jl#L76-L82">source</a></section></article><h3 id="Compatibility-with-@constraints-macro-(optional)"><a class="docs-heading-anchor" href="#Compatibility-with-@constraints-macro-(optional)">Compatibility with <code>@constraints</code> macro (optional)</a><a id="Compatibility-with-@constraints-macro-(optional)-1"></a><a class="docs-heading-anchor-permalink" href="#Compatibility-with-@constraints-macro-(optional)" title="Permalink"></a></h3><p>To make custom functional form constraint compatible with the <code>@constraints</code> macro, it must implement a new method for the <a href="#ReactiveMP.make_form_constraint"><code>make_form_constraint</code></a> function.</p><article class="docstring"><header><a class="docstring-binding" id="ReactiveMP.make_form_constraint" href="#ReactiveMP.make_form_constraint"><code>ReactiveMP.make_form_constraint</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">make_form_constraint(::Type, args...; kwargs...)</code></pre><p>Creates form constraint object based on passed <code>type</code> with given <code>args</code> and <code>kwargs</code>. Used to simplify form constraint specification.</p><p>As an example:</p><pre><code class="language-julia hljs">make_form_constraint(PointMass)</code></pre><p>creates an instance of <code>PointMassFormConstraint</code> and </p><pre><code class="language-julia hljs">make_form_constraint(SampleList, 5000, LeftProposal())</code></pre><p>should create an instance of <code>SampleListFormConstraint</code>.</p><p>See also: <a href="#ReactiveMP.AbstractFormConstraint"><code>AbstractFormConstraint</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/biaslab/ReactiveMP.jl/blob/3ad37f768f4329098e47988cb2ee2b26bbfa75f3/src/constraints/form.jl#L94-L113">source</a></section></article><h2 id="custom-functional-form-example"><a class="docs-heading-anchor" href="#custom-functional-form-example">Custom Functional Form Example</a><a id="custom-functional-form-example-1"></a><a class="docs-heading-anchor-permalink" href="#custom-functional-form-example" title="Permalink"></a></h2><p>In this demo we show how to build a custom functional form constraint that is compatible with the <code>ReactiveMP.jl</code> inference backend. An important part of the functional forms constraint implementation is the <a href="../../lib/prod/#Base.prod-Tuple{ProdAnalytical, Any, Any}"><code>prod</code></a> function. More information about <a href="../../lib/prod/#Base.prod-Tuple{ProdAnalytical, Any, Any}"><code>prod</code></a> function is present in the <a href="../../lib/prod/#lib-prod">Prod Implementation</a> section. We show a relatively simple use-case, which might not be very useful in practice, but serves as a simple step-by-step guide. Assume that we want a specific posterior marginal of some random variable in our model to have a specific Gaussian parametrisation, for example mean-precision. We can use built-in <code>NormalMeanPrecision</code> distribution, but we still need to define our custom functional form constraint:</p><pre><code class="language-julia hljs">using ReactiveMP

# First we define our functional form structure with no fields
struct MeanPrecisionFormConstraint &lt;: AbstractFormConstraint end</code></pre><p>Next we define the behaviour of our functional form constraint:</p><pre><code class="language-julia hljs">ReactiveMP.is_point_mass_form_constraint(::MeanPrecisionFormConstraint) = false
ReactiveMP.default_form_check_strategy(::MeanPrecisionFormConstraint)   = FormConstraintCheckLast()
ReactiveMP.default_prod_constraint(::MeanPrecisionFormConstraint)       = ProdGeneric()

function ReactiveMP.constrain_form(::MeanPrecisionFormConstraint, distribution)
    # This is quite a naive assumption, that a given `dsitribution` object has `mean` and `precision` defined
    # However this quantities might be approximated with some other external method, e.g. Laplace approximation
    m = mean(distribution)      # or approximate with some other method
    p = precision(distribution) # or approximate with some other method
    return NormalMeanPrecision(m, p)
end

function ReactiveMP.constrain_form(::MeanPrecisionFormConstraint, distribution::DistProduct)
    # DistProduct is the special case, read about this type more in the corresponding documentation section
    # ...
end</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../">« Introduction</a><a class="docs-footer-nextpage" href="../custom-addons/">Custom addons »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Monday 18 September 2023 08:37">Monday 18 September 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
